<% layout('layout') %>
<div class="header">
    <div class="page-title"><%= workflow ? 'Edit Workflow' : 'Create Workflow' %></div>
    <div class="header-actions">
        <a href="/workflows" class="btn btn-secondary"><i class="fas fa-arrow-left btn-icon"></i>Back to Workflows</a>
    </div>
</div>
<form action="<%= workflow ? '/workflows/' + workflow.id + '/edit' : '/workflows/new' %>" method="POST" id="workflow-form">
    <div class="form-group">
        <label class="form-label">Workflow Name</label>
        <input type="text" name="name" class="form-control" value="<%= workflow ? workflow.name : '' %>" required>
    </div>
    <div id="steps-container">
        <% let steps = workflow ? workflow.steps : []; %>
        <% steps.forEach(function(step, idx) { %>
            <div class="workflow-step">
                <div class="step-number"><%= idx+1 %></div>
                <div class="form-group">
                    <label class="form-label">Step Type</label>
                    <select class="form-control step-type">
                        <option value="email" <%= step.type === 'email' ? 'selected' : '' %>>Email</option>
                        <option value="phone" <%= step.type === 'phone' ? 'selected' : '' %>>Phone Call</option>
                        <option value="linkedin" <%= step.type === 'linkedin' ? 'selected' : '' %>>LinkedIn Message</option>
                        <option value="event" <%= step.type === 'event' ? 'selected' : '' %>>Event Invite</option>
                        <option value="package" <%= step.type === 'package' ? 'selected' : '' %>>Send Package</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Delay (days)</label>
                    <input type="number" class="form-control step-delay" value="<%= step.delay_days %>" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-control step-role">
                        <option value="admin" <%= step.role === 'admin' ? 'selected' : '' %>>Admin</option>
                        <option value="manager" <%= step.role === 'manager' ? 'selected' : '' %>>Manager</option>
                        <option value="team-member" <%= step.role === 'team-member' ? 'selected' : '' %>>Team Member</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Template</label>
                    <textarea class="form-control step-template"><%= step.template %></textarea>
                </div>
            </div>
        <% }) %>
    </div>
    <input type="hidden" name="steps" id="steps-json">
    <button type="button" class="btn btn-secondary" id="add-step-btn">Add Step</button>
    <button type="submit" class="btn btn-primary">Save Workflow</button>
</form>
<script>
    function serializeSteps() {
        var steps = [];
        document.querySelectorAll('#steps-container .workflow-step').forEach(function(stepDiv) {
            steps.push({
                type: stepDiv.querySelector('.step-type').value,
                delay_days: stepDiv.querySelector('.step-delay').value,
                role: stepDiv.querySelector('.step-role').value,
                template: stepDiv.querySelector('.step-template').value
            });
        });
        document.getElementById('steps-json').value = JSON.stringify(steps);
    }
    document.getElementById('add-step-btn').addEventListener('click', function() {
        var stepsContainer = document.getElementById('steps-container');
        var idx = stepsContainer.children.length;
        var stepDiv = document.createElement('div');
        stepDiv.className = 'workflow-step';
        stepDiv.innerHTML = `
            <div class="step-number">${idx+1}</div>
            <div class="form-group">
                <label class="form-label">Step Type</label>
                <select class="form-control step-type">
                    <option value="email">Email</option>
                    <option value="phone">Phone Call</option>
                    <option value="linkedin">LinkedIn Message</option>
                    <option value="event">Event Invite</option>
                    <option value="package">Send Package</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Delay (days)</label>
                <input type="number" class="form-control step-delay" value="0" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">Role</label>
                <select class="form-control step-role">
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                    <option value="team-member">Team Member</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Template</label>
                <textarea class="form-control step-template"></textarea>
            </div>
        `;
        stepsContainer.appendChild(stepDiv);
    });
    document.getElementById('workflow-form').addEventListener('submit', function(e) {
        serializeSteps();
    });
</script>
