<% layout('layout') %>
<div class="header">
    <div class="page-title">Tasks Inbox</div>
    <div class="header-actions">
        <form method="GET" action="/tasks" class="filters">
            <select name="workflow_id" class="filter-select">
                <option value="">All Workflows</option>
                <% workflows.forEach(function(wf) { %>
                    <option value="<%= wf.id %>" <%= wf.id == filter.workflow_id ? 'selected' : '' %>><%= wf.name %></option>
                <% }) %>
            </select>
            <select name="company_id" class="filter-select">
                <option value="">All Companies</option>
                <% companies.forEach(function(company) { %>
                    <option value="<%= company.id %>" <%= company.id == filter.company_id ? 'selected' : '' %>><%= company.name %></option>
                <% }) %>
            </select>
            <select name="status" class="filter-select">
                <option value="">All Status</option>
                <option value="pending" <%= filter.status == 'pending' ? 'selected' : '' %>>Pending</option>
                <option value="completed" <%= filter.status == 'completed' ? 'selected' : '' %>>Completed</option>
            </select>
            <button type="submit" class="btn btn-secondary">Filter</button>
        </form>
    </div>
</div>
<div class="card">
    <div class="card-header">Tasks</div>
    <div class="card-body">
        <% if (tasks.length) { %>
            <% tasks.forEach(function(task) { %>
                <div class="task-item">
                    <div class="task-title"><%= task.type %> for <%= task.contact_name %> at <%= task.company_name %></div>
                    <div class="task-due">Due: <%= task.due_date %></div>
                    <div>Status: <span class="status-badge status-<%= task.status %>"><%= task.status %></span></div>
                    <% if (user && (user.role === 'admin' || user.role === 'manager')) { %>
                        <form action="/tasks/<%= task.id %>/assign" method="POST" style="display:inline; margin-right:0.5rem;">
                            <select name="assigned_to" class="form-control" style="width:160px;display:inline-block;">
                                <option value="">Assign to...</option>
                                <% teamMembers.forEach(function(member) { %>
                                    <option value="<%= member.id %>" <%= task.assigned_to == member.id ? 'selected' : '' %>><%= member.name %> (<%= member.email %>)</option>
                                <% }) %>
                            </select>
                            <button type="submit" class="btn btn-sm btn-primary">Assign</button>
                        </form>
                    <% } %>
                    <% if (task.status === 'pending') { %>
                        <form action="/tasks/<%= task.id %>/complete" method="POST" style="display:inline;">
                            <input type="text" name="notes" placeholder="Notes" class="form-control" style="width:200px;display:inline-block;">
                            <button type="submit" class="btn btn-sm btn-success">Mark Complete</button>
                        </form>
                    <% } %>
                </div>
            <% }) %>
        <% } else { %>
            <div>No tasks found.</div>
        <% } %>
    </div>
</div>
